---
layout:     post
title:      "浅析中育的身份验证"
subtitle:   " \"JWT & HASH\""
date:       2022-06-06
author:     "LoliconMe"
link-header: https://s2.loli.net/2022/06/06/xa9gA1Uj4ndK2Wk.png
catalog: true
tags:
    - 中育科教
    - 在线专栏
    - 云笔记
    - 优课畅学
    - 随身答
    - 技术
    - 原理
---

# Introduction

使用平板时，你是否会好奇，网络错误时蹦出的网址为什么那么长？
特别是如下一串eyJh打头的乱码到底是什么？
>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjIyNjk0IiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZSI6IjE5OTgwMTAxIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjoiU3R1ZGVudCIsInN1YiI6Ijk5OTk5OSIsImp0aSI6Im51bGwiLCJpYXQiOjE2NDk3MjQxNjgsIm5iZiI6MTY0OTcyNDE2OCwiZXhwIjoxNjQ5NzMxMzY4LCJpc3MiOiJFenkiLCJhdWQiOiJaeWtKOTk4OCJ9.d-zjoYSxo2nAsPdnytqeBbHGpA1WcqKio6cRPWOiqMo

**这就是采用JWT(全称：Json Web Token)的Token校验**

# What is Authentication?

身份认证（Authentication）也叫身份验证或者鉴权，指通过一定的手段来完成对用户身份的验证。

下内容引自[yehongzhi](https://github.com/yehongzhi/learningSummary/blob/8f7901dceac2bf3ecf8c81d73340de4f8310c4b7/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/JWT.md)

### 起源

需要了解一门技术，首先从为什么产生开始说起是最好的。JWT主要用于用户登录鉴权，所以我们从最传统的session认证开始说起。

#### session认证

众所周知，http协议本身是无状态的协议，那就意味着当有用户向系统使用账户名称和密码进行用户认证之后，下一次请求还要再一次用户认证才行。因为我们不能通过http协议知道是哪个用户发出的请求，所以如果要知道是哪个用户发出的请求，那就需要在服务器保存一份用户信息(保存至session)，然后在认证成功后返回cookie值传递给浏览器，那么用户在下一次请求时就可以带上cookie值，服务器就可以识别是哪个用户发送的请求，是否已认证，是否登录过期等等。这就是传统的session认证方式。

session认证的缺点其实很明显，由于session是保存在服务器里，所以如果分布式部署应用的话，会出现session不能共享的问题，很难扩展。于是乎为了解决session共享的问题，又引入了redis，接着往下看。

#### token认证

这种方式跟session的方式流程差不多，不同的地方在于保存的是一个token值到redis，token一般是一串随机的字符(比如UUID)，value一般是用户ID，并且设置一个过期时间。每次请求服务的时候带上token在请求头，后端接收到token则根据token查一下redis是否存在，如果存在则表示用户已认证，如果token不存在则跳到登录界面让用户重新登录，登录成功后返回一个token值给客户端。

优点是多台服务器都是使用redis来存取token，不存在不共享的问题，所以容易扩展。缺点是每次请求都需要查一下redis，会造成redis的压力，还有增加了请求的耗时，每个已登录的用户都要保存一个token在redis，也会消耗redis的存储空间。

有没有更好的方式呢？接着往下看。

### 什么是JWT

JWT(全称：Json Web Token)是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为JSON对象在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。

上面说法比较文绉绉，简单点说就是一种认证机制，让后台知道该请求是来自于受信的客户端。

首先我们先看一个流程图：

![](https://static.lovebilibili.com/jwt_01.png)

流程描述一下：

1. 用户使用账号、密码登录应用，登录的请求发送到Authentication Server。
2. Authentication Server进行用户验证，然后创建JWT字符串返回给客户端。
3. 客户端请求接口时，在请求头带上JWT。
4. Application Server验证JWT合法性，如果合法则继续调用应用接口返回结果。

可以看出与token方式有一些不同的地方，就是不需要依赖redis，用户信息存储在客户端。所以关键在于生成JWT，和解析JWT这两个地方。

#### JWT的数据结构

JWT一般是这样一个字符串，分为三个部分，以"."隔开：

```java
xxxxx.yyyyy.zzzzz
```

![](https://static.lovebilibili.com/jwt_02.jpg)

#### Header

JWT第一部分是头部分，它是一个描述JWT元数据的Json对象，通常如下所示。

```json
{
    "alg": "HS256",
    "typ": "JWT"
}
```

alg属性表示签名使用的算法，默认为HMAC SHA256（写为HS256），typ属性表示令牌的类型，JWT令牌统一写为JWT。

最后，使用Base64 URL算法将上述JSON对象转换为字符串保存。

#### Payload

JWT第二部分是Payload，也是一个Json对象，除了包含需要传递的数据，还有七个默认的字段供选择。

分别是，iss：发行人、exp：到期时间、sub：主题、aud：用户、nbf：在此之前不可用、iat：发布时间、jti：JWT ID用于标识该JWT。

如果自定义字段，可以这样定义：

```json
{
    //默认字段
    "sub":"主题123",
    //自定义字段
    "name":"java技术爱好者",
    "isAdmin":"true",
    "loginTime":"2021-12-05 12:00:03"
}
```

需要注意的是，默认情况下JWT是未加密的，任何人都可以解读其内容，因此如果一些敏感信息不要存放在此，以防信息泄露。

JSON对象也使用Base64 URL算法转换为字符串保存。

#### Signature

JWT第三部分是签名。是这样生成的，首先需要指定一个secret，该secret仅仅保存在服务器中，保证不能让其他用户知道。然后使用Header指定的算法对Header和Payload进行计算，然后就得出一个签名哈希。也就是Signature。

那么Application Server如何进行验证呢？可以利用JWT前两段，用同一套哈希算法和同一个secret计算一个签名值，然后把计算出来的签名值和收到的JWT第三段比较，如果相同则认证通过。

### JWT的优点

- json格式的通用性，所以JWT可以跨语言支持，比如Java、JavaScript、PHP、Node等等。
- 可以利用Payload存储一些非敏感的信息。
- 便于传输，JWT结构简单，字节占用小。
- 不需要在服务端保存会话信息，易于应用的扩展。

### 总结

最后讲讲JWT的缺点，任何技术都不是完美的，所以我们得用辩证思维去看待任何一项技术。

- 安全性没法保证，所以jwt里不能存储敏感数据。因为jwt的payload并没有加密，只是用Base64编码而已。
- 无法中途废弃。因为一旦签发了一个jwt，在到期之前始终都是有效的，如果用户信息发生更新了，只能等旧的jwt过期后重新签发新的jwt。
- 续签问题。当签发的jwt保存在客户端，客户端一直在操作页面，按道理应该一直为客户端续长有效时间，否则当jwt有效期到了就会导致用户需要重新登录。那么怎么为jwt续签呢？最简单粗暴就是每次签发新的jwt，但是由于过于暴力，会影响性能。如果要优雅一点，又要引入Redis解决，但是这又把无状态的jwt硬生生变成了有状态的，违背了初衷。

# ZYKJ Token
下面分析几个中育的Token，以篇首一例来说，这是在线专栏的token。我们使用[JWT官网](https://jwt.io/)解析一下
![image.png](https://s2.loli.net/2022/06/06/WVY7mowljEdLUB5.png)
结构非常清晰
+ Header部分：alg: HS256，表示使用HS256算法进行加密
+ Payload部分：涵盖了用户信息，第一项User Id，第二项User Account，第三项User role，余见下图
![image.png](https://s2.loli.net/2022/06/06/Lc5h3YX9ufwOpsj.png)

有兴趣的同学可以看看其他中育的token，例如云笔记与优课畅学，都是独立的token

值得一提的是，优课畅学使用的token中，用户名以貌似MD5的hash呈现，进一步稳固了token的安全性

# Crack
暴力是最美妙的算法，对于jwt，同样可以暴力解出密钥，这里是一个开源的[破解程序](https://github.com/brendan-rius/c-jwt-cracker)
若你能爆破中育的Token，行政楼208领奶茶去！（但是可能只有处分单）

> If you are very lucky or have a huge computing power

# 结语
Token还是不太好破，但是有了Token即使没有密码也能登录，保护Token是很重要的，老师们一定要小心（绝对没有人会在sxz劫持抓包老师token对不对，对不对？）